from pyrogram import Client, filters
from pyrogram.types import Message

from keyboards.bot_keyboards import form_webapp_kbrd
from utils.req_to_bot_api import post_for_write_user, get_gpt_answer
from settings.config import MY_LOGGER, NEW_APPLICATION_FORM_URL


@Client.on_message(filters.command(['start', 'menu']))
async def start_handler(_, update):
    """
    –•—ç–Ω–¥–ª–µ—Ä –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –±–æ—Ç–∞
    """
    MY_LOGGER.info(f'–°—Ä–∞–±–æ—Ç–∞–ª —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —Ö—ç–Ω–¥–ª–µ—Ä –¥–ª—è —é–∑–µ—Ä–∞ {update.from_user.id!r}')
    write_usr_rslt = await post_for_write_user(tlg_username=update.from_user.username, tlg_id=update.from_user.id)
    if write_usr_rslt:
        await update.reply_text(
            text=f'üëã –ü—Ä–∏–≤–µ—Ç!\n\nüêù –Ø –±–æ—Ç —Å –ò–ò, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é –∫–æ–º–ø–∞–Ω–∏—é <b>"–û–°–ê –ê–≤—Ç–æ—ç–∫—Å–ø–µ—Ä—Ç"</b>.\n\n'
                 f'üéØ –ù–∞—à–∞ —Ü–µ–ª—å - <b>—Å–æ–¥–µ–π—Å—Ç–≤–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Å—Ç–∞–º</b> –≤ —Å–ª–æ–∂–Ω—ã—Ö –¥–æ—Ä–æ–∂–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö.\n\n'
                 f'ü§ù –í–æ—Ç —á–∞—Å—Ç—å –ø—Ä–æ–±–ª–µ–º, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –ø–æ–º–æ–≥–∞–µ–º —Ä–µ—à–∏—Ç—å –ª—é–¥—è–º:\n'
                 f'üîπ –Ω–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç –∏ –æ–±–º–∞–Ω —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–æ–≤\n'
                 f'üîπ —É–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –≤—ã–ø–ª–∞—Ç —Å—Ç—Ä–∞—Ö–æ–≤—ã–º–∏ –∫–æ–º–ø–∞–Ω–∏—è–º–∏\n'
                 f'üîπ –æ—Ç—Å—Ç–∞–∏–≤–∞–Ω–∏–µ –í–∞—à–∏—Ö –ø—Ä–∞–≤ –≤ —Å—É–¥–µ –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ...\n\n'
                 f'üñã –ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –í–∞—à –≤–æ–ø—Ä–æ—Å, —á—Ç–æ–±—ã —è —Å–º–æ–≥ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –í–∞–º –ø–æ–º–æ—á—å.\n\n<b>–ù–∞–ø—Ä–∏–º–µ—Ä:</b>\n'
                 f'<i>–°—Ç—Ä–∞—Ö–æ–≤–∞—è –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã, –Ω–µ –º–æ–≥—É –ø–æ–ª—É—á–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É, —á—Ç–æ –¥–µ–ª–∞—Ç—å?</i>\n'
                 f'<i>–ß—Ç–æ –æ–±—è–∑–∞–Ω –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å, –µ—Å–ª–∏ —Å–ª–æ–º–∞–ª—Å—è –∞–≤—Ç–æ–º–æ–±–∏–ª—å –ø–æ—Å–ª–µ –Ω–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞?</i>\n'
                 f'<i>–ü—Ä–æ–∏–∑–æ—à–ª–æ –î–¢–ü, —á—Ç–æ –Ω—É–∂–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –ø–æ–ª—É—á–∏—Ç—å –≤–æ–∑–º–µ—â–µ–Ω–∏–µ —É—â–µ—Ä–±–∞?</i>\n\n'
                 f'üë®‚Äçüíº –ò–ª–∏ –º–æ–∂–µ—Ç–µ —Å—Ä–∞–∑—É <b>–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</b>, —á—Ç–æ–±—ã —Å–≤—è–∑–∞—Ç—å—Å—è —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.',
            reply_markup=await form_webapp_kbrd(form_link=NEW_APPLICATION_FORM_URL,
                                                btn_text='üì± –°–≤—è–∑–∞—Ç—å—Å—è —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º')
        )

    else:
        MY_LOGGER.error(f'–Æ–∑–µ—Ä {update.from_user.id!r} –ø–æ–ª—É—á–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ —É –±–æ—Ç–∞ —Ç–µ—Ö —Ä–∞–±–æ—Ç—ã!')
        await update.reply_text(
            text=f'–£ –±–æ—Ç–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã. –ú—ã —Å–∫–æ—Ä–æ –∑–∞–∫–æ–Ω—á–∏–º.ü™õ'
        )


@Client.on_message(filters.private)
async def ai_answer_handler(_, update: Message):
    """
    –•—ç–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ ChatGPT.
    """
    MY_LOGGER.info(f'–°—Ä–∞–±–æ—Ç–∞–ª —Ö—ç–Ω–¥–ª–µ—Ä –¥–ª—è –ò–ò –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {update.from_user.id!r}')
    info_msg = await update.reply_text(
        text=f'<b>üêù –ò–ò "OSA_GPT"</b> –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç, –Ω—É–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å...‚è±',
        disable_notification=True,
    )
    gpt_answer = await get_gpt_answer(user_msg=update.text)
    await info_msg.delete()
    if not gpt_answer:
        await update.reply_text(text=f'ü§∑‚Äç‚ôÇÔ∏è –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, <b>–ò–ò –Ω–µ —Å–º–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç</b> –∏–∑-–∑–∞ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ '
                                     f'—Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ ‚åõÔ∏è')
        return

    await update.reply_text(
        text=f"<b>–û—Ç–≤–µ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ 'üêù OSA_GPT':</b>\n\n{gpt_answer.get('gpt_answer')}",
        reply_markup=await form_webapp_kbrd(form_link=NEW_APPLICATION_FORM_URL,
                                            btn_text='üì± –°–≤—è–∑–∞—Ç—å—Å—è —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º')
    )
